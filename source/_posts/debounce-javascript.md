---
title: T·ªëi ∆∞u v·ªõi Debounce?
date: 2019-06-15 22:00:00
authorId: chau_tran
tags: javascript, debounce, optimization
---

![Debounce](http://image.slidesharecdn.com/slides-140813225923-phpapp01/95/throttle-and-debounce-patterns-in-web-apps-55-638.jpg)

Khi c√°c b·∫°n "d·∫°o quanh" c√°c ·ª©ng d·ª•ng (web, mobile, .v.v...), c√°c b·∫°n c√≥ ƒë·ªÉ √Ω b·∫Øt g·∫∑p ph·∫£i m·ªôt `input` m√† khi b·∫°n type v√†o, b·∫°n ph·∫£i ch·ªù m·ªôt ch√∫t th√¨ m·ªõi c√≥ g√¨ ƒë√≥ x·∫£y ra kh√¥ng? ƒê·∫°i lo·∫°i nh∆∞ v√≠ d·ª• sau:

<!-- more -->

![debounce-in-action](https://cdn-images-1.medium.com/max/1600/1*aNqkqLafqoI9FIHcwubqaA.gif)

Th·ª±c s·ª± th√¨ ƒë√¢y kh√¥ng ph·∫£i l√† ·ª©ng d·ª•ng b·ªã ch·∫≠m hay l·ªói g√¨ ƒë√¢u nh√© üòÅ. ƒê√¢y g·ªçi l√†, `Debounce`, m·ªôt k·ªπ thu·∫≠t ƒë∆∞·ª£c √°p d·ª•ng r·ªông r√£i ƒë·ªÉ t·ªëi ∆∞u h√≥a performance c·ªßa ·ª©ng d·ª•ng b·∫±ng c√°ch gi·∫£m thi·ªÉu s·ªë l·∫ßn ·ª©ng d·ª•ng ph·∫£i x·ª≠ l√Ω nh·ªØng s·ª± ki·ªán (**event**) mang t√≠nh *li√™n t·ª•c*. ƒê·ªÉ ti·∫øp n·ªëi nh·ªØng **k·ªπ thu·∫≠t t·ªëi ∆∞u h√≥a c∆° b·∫£n**, th√¨ h√¥m nay m√¨nh s·∫Ω gi·ªõi thi·ªáu v·ªõi c√°c b·∫°n k·ªπ thu·∫≠t `Debounce`.

# 1. Debounce l√† g√¨?

`Debounce` l√† m·ªôt h√†m b·∫≠c cao (**high-order function**) d√πng ƒë·ªÉ l√†m tr√¨ ho√£n vi·ªác x·ª≠ l√Ω `event` n√†o ƒë√≥ cho ƒë·∫øn khi kh√¥ng c√≥ `event` n√†o ƒë∆∞·ª£c emitted (**b·∫Øn**) ra trong m·ªôt kho·∫£n th·ªùi gian (**delay**) ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh tr∆∞·ªõc. `Debounce` c√≥ m·ªôt *ng∆∞·ªùi b√† con* l√† `Throttle`. `Debounce` th∆∞·ªùng ƒë∆∞·ª£c √°p d·ª•ng cho: `Autocomplete`, `Typeahead` ho·∫∑c `Filter input` k√®m v·ªõi nh·ªØng s·ª± ki·ªán nh∆∞: `keyup` v√† `change`. C√≤n `Throttle` th∆∞·ªùng ƒë∆∞·ª£c √°p d·ª•ng cho nh·ªØng s·ª± ki·ªán li√™n quan ƒë·∫øn `mousemove`. Nh∆∞ng b√†i vi·∫øt n√†y l√† n√≥i ƒë·∫øn `Debounce` m√† üòú, `Throttle` th√¨ h·∫πn l·∫ßn sau nhe. 

T·∫°i sao l·∫°i ph·∫£i ho√£n vi·ªác x·ª≠ l√Ω `event` l·∫°i? Ph·∫ßn l·ªõn, x·ª≠ l√Ω nh·ªØng s·ª± ki·ªán t·ª´ `input` th∆∞·ªùng li√™n quan ƒë·∫øn g·ªçi `API` (**network**) ho·∫∑c x·ª≠ l√Ω m·∫£ng (**array**). N·∫øu nh∆∞ nh·ªØng t√°c v·ª• (**operation**) n√†y t·ªën nhi·ªÅu t√†i nguy√™n v√† th·ªùi gian c·ªßa ·ª©ng d·ª•ng, v√† m·ªói m·ªôt s·ª± ki·ªán t·ª´ `input` (`keyup` ch·∫≥ng h·∫°n) ƒë·ªÅu *b·∫≠t ƒë√®n xanh* cho c√°c t√°c v·ª• n√†y th√¨ c√°c b·∫°n nghƒ© l√† ·ª©ng d·ª•ng m√¨nh c√≥ b·ªã ch·∫≠m ƒëi kh√¥ng? V√≠ d·ª•: c√°c b·∫°n mu·ªën l·ªçc (**filter**) c√°c `users` c√≥ ch·ªØ: `tran` trong t√™n c·ªßa h·ªç, th√¨ ch·∫Øc ch·∫Øn c√°c b·∫°n ch·ªâ mu·ªën ·ª©ng d·ª•ng m√¨nh quan t√¢m ƒë·∫øn ch·ªØ `tran` th√¥i. N·∫øu nh∆∞ kh√¥ng c√≥ `debounce`, th√¨ ·ª©ng d·ª•ng s·∫Ω quan t√¢m ƒë·∫øn c·∫£ `t`, `tr`, `tra` r·ªìi m·ªõi ƒë·∫øn `tran`. R·ªët cu·ªôc l√† m√¨nh l√£ng ph√≠ m·∫•t 3 l·∫ßn x·ª≠ l√Ω kh√¥ng c·∫ßn thi·∫øt r√πi üò•, ch∆∞a k·ªÉ ƒë·∫øn vi·ªác `race-condition` (**hi·ªán t∆∞·ª£ng out of sync, k·∫øt qu·∫£ v·ªÅ tr∆∞·ªõc v·ªÅ sau**) r·∫•t l√† kh√≥ `debug` v√† d·ªÖ d·∫´n ƒë·∫øn *x√¨-tr√©t* l·∫Øm. V√† `Debounce` s·∫Ω gi√∫p b·∫°n x√£ 1 s·ªë *x√¨-tr√©t* kh√¥ng ƒë√°ng c√≥ üòé

# 2. Debounce tr√¥ng nh∆∞ th·∫ø n√†o trong JavaScript?

M√¨nh d√πng `JavaScript` ƒë·ªÉ m√¥ t·∫£ cho c√°c b·∫°n n·∫Øm ƒë∆∞·ª£c nguy√™n l√Ω c∆° b·∫£n c·ªßa `debounce` nh√©. Nh·ªØng ng√¥n ng·ªØ kh√°c v·∫´n c√≥ th·ªÉ √°p d·ª•ng nh√©. V·ªÅ c∆° b·∫£n, th√¨ m·ªôt h√†m `debounce` nh√¨n s·∫Ω nh∆∞ sau:

```javascript
// Credit t·ª´ David Walsh: https://davidwalsh.name/javascript-debounce-function

// debounce s·∫Ω return fn v√† fn s·∫Ω kh√¥ng ch·∫°y cho ƒë·∫øn khi debounce kh√¥ng ƒë∆∞·ª£c th·ª±c thi
// trong kho·∫£n th·ªùi gian delay. N·∫øu immediate l√† true, th√¨ fn s·∫Ω ƒë∆∞·ª£c th·ª±c thi ngay l·∫∑p t·ª©c
// r·ªìi m·ªõi ƒë∆∞·ª£c debounced cho nh·ªØng l·∫ßn ti·∫øp theo.
function debounce(fn, delay, immediate) {
    let timeout;
    
    return function executedFn() {
        let context = this; // "this" context c·ªßa executedFn
        let args = arguments; // "arguments" c·ªßa fn
        
        let later = function() {
            timeout = null;
            if (!immediate) fn.apply(context, args);
        };
        
        let callNow = immediate && !timeout;
        
        clearTimeout(timeout);
        
        timeout = setTimeout(later, delay);
        
        if (callNow) fn.apply(context, args);
    }
}
```

Nh∆∞ ƒë√£ ƒë∆∞·ª£c ƒë·ªÅ c·∫≠p ·ªü ƒë·∫ßu b√†i, `debounce` l√† m·ªôt `High-order function` s·∫Ω return 1 `function`. Vi·ªác n√†y nh·∫±m ƒë·ªÉ t·∫°o n√™n 1 `closure` cho c√°c tham s·ªë c·ªßa debounce: `fn`, `delay` v√† `immediate`; v√† bi·∫øn c·ª•c b·ªô (**local variable**) `timeout`.

- `fn`: ƒê√¢y l√† `function` m√† c√°c b·∫°n mu·ªën ho√£n (**debounced**)
- `delay`: ƒê√¢y l√† th·ªùi gian c√°c b·∫°n mu·ªën tr√¨ ho√£n (v√¨ `delay` s·∫Ω ƒë∆∞·ª£c d√πng cho `setTimeout` n√™n c√≥ ƒë∆°n v·ªã l√† `ms` nha)
- `immediate`: ƒê√¢y l√† m·ªôt tham s·ªë `boolean`. Tham s·ªë n√†y, n·∫øu `true`, th√¨ `fn` s·∫Ω ƒë∆∞·ª£c th·ª±c thi ngay l·∫∑p t·ª©c ·ªü l·∫ßn ƒë·∫ßu ti√™n v√† ƒë∆∞·ª£c `delay` cho nh·ª´ng l·∫ßn k·∫ø ti·∫øp.
- `timeout`: ƒê√¢y l√† bi·∫øn c·ª•c b·ªô c·ªßa `debounce` ƒë·ªÉ gi·ªØ tham chi·∫øu (**reference**) ƒë·∫øn v·ªõi `setTimeout`, ƒë·ªÉ c√≥ th·ªÉ `clearTimeout` v√† t·∫°o 1 `setTimeout` m·ªõi khi `debounce` ƒë∆∞·ª£c th·ª±c thi khi th·ªùi gian `delay` v·∫´n ch∆∞a ch·∫°y xong.

Sau ƒë√¢y l√† c√°ch √°p d·ª•ng:

```javascript
const input = document.getElementById('filterInput');

const keyUpHandler = event => {
    // do something with event
};

const debouncedKeyUp = debounce(keyUpHandler, 500); 

input.addEventListener('keyup', debouncedKeyUp);
```
·ªû v√≠ d·ª• n√†y, m√¨nh s·∫Ω `debounced` `keyUpHandler` `500ms`. Nghƒ©a l√†, n·∫øu nh∆∞ `input` n√†y ƒë∆∞·ª£c type li√™n t·ª•c v√† `debouncedKeyup` s·∫Ω ƒë∆∞·ª£c th·ª±c thi khi ng∆∞·ªùi d√πng ng·ª´ng type trong v√≤ng `500ms`. ƒê·ªÉ hi·ªÉu r√µ h∆°n, m√¨nh s·∫Ω vi·∫øt l·∫°i block c·ªßa h√†m `debounce` ph√≠a tr√™n k√®m theo comment nh√©:
```javascript
// Credit t·ª´ David Walsh: https://davidwalsh.name/javascript-debounce-function

// debounce s·∫Ω return fn v√† fn s·∫Ω kh√¥ng ch·∫°y cho ƒë·∫øn khi debounce kh√¥ng ƒë∆∞·ª£c th·ª±c thi
// trong kho·∫£n th·ªùi gian delay. N·∫øu immediate l√† true, th√¨ fn s·∫Ω ƒë∆∞·ª£c th·ª±c thi ngay l·∫∑p t·ª©c
// r·ªìi m·ªõi ƒë∆∞·ª£c debounced cho nh·ªØng l·∫ßn ti·∫øp theo.
function debounce(fn, delay, immediate) {
    let timeout;
    
    // ƒê√¢y l√† function s·∫Ω ƒë∆∞·ª£c th·ª±c thi khi debouncedKeyUp ƒë∆∞·ª£c th·ª±c thi ·ªü v√≠ d·ª• tr√™n
    return function executedFn() {
        // M√¨nh save l·∫°i this v√†o bi·∫øn context
        let context = this; // "this" context c·ªßa executedFn
        
        // Save l·∫°i arguments v√†o args. Trong JS, arguments gi·ªØ gi√° tr·ªã c·ªßa t·∫•t c·∫£ tham s·ªë ƒë∆∞·ª£c truy·ªÅn v√†o cho m·ªôt function.
        // Cho d√π b·∫°n kh√¥ng khai b√°o tham s·ªë cho m·ªôt h√†m, th√¨ khi truy·ªÅn tham s·ªë v√†o cho h√†m ƒë√≥, c√°c b·∫°n v·∫´n c√≥ th·ªÉ truy xu·∫•t
        // ƒë·∫øn c√°c tham s·ªë b·∫±ng bi·∫øn arguments n√†y. Theo v√≠ d·ª• tr√™n, th√¨ arguments ·ªü ƒë√¢y s·∫Ω ch·ª©a "event" 
        let args = arguments; // "arguments" c·ªßa fn
        
        // Function later n√†y s·∫Ω ƒë∆∞·ª£c g·ªçi sau khi delay ƒë∆∞·ª£c ch·∫°y xong. 
        // Nghƒ©a l√† m√¨nh return executedFn, khi executedFn ƒë∆∞·ª£c th·ª±c thi th√¨ sau kho·∫£n delay, later s·∫Ω ƒë∆∞·ª£c th·ª±c thi.
        let later = function() {
            // G√°n null cho timeout => cho th·∫•y delay ƒë√£ ch·∫°y xong
            timeout = null;
            
            // G·ªçi h√†m fn v·ªõi apply
            if (!immediate) fn.apply(context, args);
        };
        
        // X√°c ƒë·ªãnh xem n√™n g·ªçi fn d·ª±a v√†o tham s·ªë immediate
        let callNow = immediate && !timeout;
        
        // D√≤ng clearTimeout s·∫Ω reset timeout ƒëang hi·ªán h·ªØu (**existed**). ƒê√¢y l√† ƒëi·ªÅu c·∫ßn thi·∫øt, 
        // v√¨ m√¨nh c·∫ßn h·ªßy timeout v√† t·∫°o 1 timeout m·ªõi n·∫øu nh∆∞ debounce ƒë∆∞·ª£c th·ª±c thi khi 
        // delay ch∆∞a ch·∫°y xong.
        clearTimeout(timeout);
        
        // Kh·ªüi t·∫°o (l·∫°i) timeout m·ªõi v√† g√°n v√†o bi·∫øn timeout ƒë·ªÉ c√≥ th·ªÉ clear/check.
        timeout = setTimeout(later, delay);
        
        // N·∫øu nh∆∞ immediate l√† true, th√¨ m√¨nh s·∫Ω g·ªçi fn l·∫ßn ƒë·∫ßu ti√™n ·ªü ƒë√¢y.
        if (callNow) fn.apply(context, args);
    }
}
```

Ngo√†i nh·ªØng s·ª± ki·ªán `keyboard` th√¨ `debounce` c≈©ng c√≤n ƒë∆∞·ª£c √°p d·ª•ng cho `resize` v√† `scroll` n·ªØa. Nh∆∞ng t√πy tr∆∞·ªùng h·ª£p m√† devs c√≥ th·ªÉ d√πng `debounce` ho·∫∑c `throttle` cho `resize` v√† `scroll`.

# 3. √Åp d·ª•ng Debounce trong Modern JS

·ªû m·ª•c 2, tuy l√† l√Ω thuy·∫øt, nh∆∞ng s·ª± th·∫≠t th√¨ b·∫°n c√≥ th·ªÉ d√πng h√†m `debounce` ·ªü tr√™n ƒë·ªÉ √°p d·ª•ng v√†o ·ª©ng d·ª•ng `JavaScript` c·ªßa b·∫°n. Nh∆∞ng thi·ªát t√¨nh m√† n√≥i th√¨ √≠t ai m√† √°p d·ª•ng tay nh∆∞ v·∫≠y l·∫Øm üòã. Nh√¢n ƒë√¢y, m√¨nh s·∫Ω gi·ªõi thi·ªáu 3 c√°ch √°p d·ª•ng kh√°c nhau:

1. `lodash debounce`
2. `React hooks`
3. `Angular RxJS`

Note: M√¨nh kh√¥ng d√πng `VueJS` n√™n kh√¥ng c√≥ v√≠ d·ª• n√†o c·∫£ üò∂

### Lodash Debounce
N√≥i cho sang v·∫≠y th√¥i ch·ª© c√°ch n√†y v√¥ c√πng d·ªÖ. C√°c b·∫°n ch·ªâ c·∫ßn `npm install lodash` (ho·∫∑c `yarn add lodash`). Sau ƒë√≥ th√¨ code th√¥i.


<div class="iframe-container">
<iframe src="https://codesandbox.io/embed/intelligent-goldstine-n999u" style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe>
</div>

### React Hooks
K·∫ø ti·∫øp, m√¨nh s·∫Ω √°p d·ª•ng `debounce` v√†o `React` b·∫±ng: `useEffect` nh√©.

```jsx harmony
function useDebounce(text, delay) {
  delay = delay || 500;
  const [debounced, setDebounced] = useState(text);

  useEffect(() => {
    const handler = setTimeout(() => {
      setDebounced(text);
    }, delay);

    return () => {
      clearTimeout(handler);
    };
  }, [text, delay]);

  return debounced;
}

function App() {
  const [val, setVal] = useState("Hello Codesandbox");
  const [title, setTitle] = useState("Hello Codesandbox");
  const debouncedVal = useDebounce(val);

  useEffect(() => {
    if (debouncedVal) {
      setTitle(debouncedVal);
    }
  }, [debouncedVal]);

  return (
    <div className="App">
      <h1>{title}</h1>
      <h2>Try typing then stop for 0.5s</h2>
      <input
        type="text"
        value={val}
        onChange={({ target }) => setVal(target.value)}
      />
    </div>
  );
}
```
C√°c b·∫°n ƒë·ªÉ √Ω th√¨ m√¨nh √°p d·ª•ng nh∆∞ l√† h√†m `debounce` ·ªü tr√™n m·ª•c 2 tr√™n kia √° nh∆∞ng m√¨nh √°p d·ª•ng `useEffect` ƒë·ªÉ l·∫∑p ƒëi l·∫∑p l·∫°i logic clear/reset timeout d·ª±a v√†o `text` c√≥ thay ƒë·ªïi hay kh√¥ng. ƒêi·ªÅu n√†y cho m√¨nh "hi·ªáu ·ª©ng" t∆∞∆°ng t·ª± nh∆∞ h√†m `debounce()` tr√™n kia.

<div class="iframe-container">
<iframe src="https://codesandbox.io/embed/react-use-debounce-0hw7p" style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe>
</div>

### Angular RxJS `debounceTime`

Cu·ªëi c√πng, m√¨nh s·∫Ω √°p d·ª•ng `debounce` b·∫±ng 1 operator t√™n l√† `debounceTime` trong `Angular` nh√©.

```typescript
import { Component, ViewChild, ElementRef } from "@angular/core";
import { fromEvent } from "rxjs/observable/fromEvent";
import { debounceTime, map } from "rxjs/operators";

@Component({
  selector: "app-root",
  template: `
    <div style="text-align:center">
      <h1>Welcome to {{ title }}!</h1>
      <p>Try typing then stop for 0.5s</p>

      <input type="text" #someInput />

      <p>{{ value }}</p>
    </div>
  `,
  styleUrls: ["./app.component.css"]
})
export class AppComponent {
  @ViewChild("someInput", { static: true }) someInput: ElementRef<HTMLInputElement>;

  title = "CodeSandbox";
  value = "";

  ngOnInit() {
    fromEvent(this.someInput.nativeElement, "keyup")
      .pipe(
        debounceTime(500),
        map((event: any) => event.target.value)
      )
      .subscribe(val => {
        this.value = val;
      });
  }
}
```

·ªû ƒë√¢y, m√¨nh d√πng `template variable #someInput` v√† d√πng `ViewChild` ƒë·ªÉ tham chi·∫øu ƒë·∫øn `input` n√†y. Sau ƒë√≥, d√πng `fromEvent` ƒë·ªÉ chuy·ªÉn s·ª± ki·ªán `keyup` t·ª´ `input` n√†y th√†nh 1 `stream` v√† √°p d·ª•ng `debounceTime` l√™n d√≤ng s·ª± ki·ªán `keyup` n√†y. 

<div class="iframe-container">
<iframe src="https://codesandbox.io/embed/angular-h5dru" style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe>
</div>

C√°c b·∫°n c√≥ th·ªÉ th·ª≠ code ·ªü c√°c codesandbox ƒë∆∞·ª£c ƒë√≠nh k√®m nh√©.

Hy v·ªçng c√°c b·∫°n th·∫•y `debounce` c√≥ √≠ch v√† m√¨nh gi·∫£i th√≠ch ƒë·ªß ƒë·ªÉ c√°c b·∫°n hi·ªÉu v√† √°p d·ª•ng v√†o ·ª©ng d·ª•ng c·ªßa m√¨nh. T·ªëi ∆∞u h√≥a everything üòéüòé

Ch√∫c c√°c b·∫°n may m·∫Øn v√† vui v·∫ª üòÅ
